<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Data</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f4f4f9;
            color: #333;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
        }

        .container {
            max-width: 1200px;
            width: 100%;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        h1 {
            background-color: #4a90e2;
            color: #fff;
            padding: 20px;
            text-align: center;
            margin: 0;
            border-radius: 8px;
        }

        h2 {
            border-bottom: 2px solid #4a90e2;
            padding-bottom: 10px;
            margin: 20px 0;
            font-size: 1.5em;
        }

        .form-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }

        .symbol-section {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            flex: 2;
            min-width: 300px;
        }

        .symbol-input-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .symbol-input-group input {
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .symbol-input-group button {
            padding: 10px;
            border-radius: 4px;
            background-color: #4a90e2;
            color: #fff;
            cursor: pointer;
        }

        .symbol-input-group button:hover {
            background-color: #357abd;
        }

        #symbolList {
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
        }

        #symbolList li {
            padding: 10px;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
        }

        .reset-btn {
            background-color: #f44336;
            padding: 10px;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            margin-top: 10px;
        }

        .reset-btn:hover {
            background-color: #d32f2f;
        }

        .date-section {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            flex: 1;
            min-width: 300px;
        }

        .date-section input {
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
            width: 94%;
            margin-bottom: 10px;
        }

        .date-section button {
            padding: 10px;
            border-radius: 4px;
            background-color: #4a90e2;
            color: #fff;
            cursor: pointer;
            margin-top: 30px;
            width: 100%
        }

        .date-section button:hover {
            background-color: #357abd;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background-color: #fff;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            text-align: center; /* 추가: 테이블 전체 가운데 정렬 */
        }

        th, td {
            padding: 12px;
            text-align: center; /* 추가: 테이블 헤더와 데이터 셀도 명시적으로 가운데 정렬 */
        }

        th {
            background-color: #4a90e2;
            color: #fff;
        }

        tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        tr:hover {
            background-color: #f1f1f1;
        }

        a {
            color: #000; /* 검정색 글씨로 설정 */
            text-decoration: none; /* 밑줄 제거 */
        }

        a:visited {
            color: #000; /* 클릭 후에도 검정색 유지 */
        }

        a:hover {
            color: #666; /* 마우스를 올렸을 때 회색으로 변경 */
        }

        .export-btn {
            padding: 10px;
            border-radius: 4px;
            background-color: #4a90e2;
            color: #fff;
            cursor: pointer;
        }

        .export-btn:hover {
            background-color: #357abd;
        }

        /* 기업 리스트 삭제 버튼 */
        /* 공통 버튼 스타일 */
        .symbol-input-group button {
            padding: 10px; /* 기본 패딩 */
            border-radius: 4px; /* 둥근 모서리 */
            color: white; /* 글씨 색상 */
            border: none; /* 테두리 제거 */
            cursor: pointer; /* 마우스 커서를 포인터로 변경 */
            font-size: 0.9em; /* 버튼 글씨 크기 */
            transition: background-color 0.3s ease; /* 배경색 변경 애니메이션 */
        }

        /* 추가 버튼 스타일 */
        .symbol-input-group button.add-btn {
            background-color: #4a90e2; /* 추가 버튼의 원래 색상 */
        }

        .symbol-input-group button.add-btn:hover {
            background-color: #357abd; /* 추가 버튼 hover 시 색상 */
        }

        /* 삭제 버튼 스타일 */
        .symbol-input-group button.delete-btn {
            padding: 6px 12px; /* 삭제 버튼의 세로 길이를 조금 작게 설정 */
            background-color: #f44336; /* 삭제 버튼 색상 */
            color: white; /* 글씨 색상 */
        }

        .symbol-input-group button.delete-btn:hover {
            background-color: #d32f2f; /* 삭제 버튼 hover 시 색상 */
        }

        /* 로딩 컨테이너 스타일 */
        #loading-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5); /* 반투명 검정 배경 */
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999; /* 다른 요소들 위에 표시 */
        }

        /* 로딩 메시지 스타일 */
        #loading {
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            color: #4a90e2;
            font-size: 1.2em;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.min.js"></script>
    <script>
        let symbols = [];

        async function fetchSavedSymbols() {
            const response = await fetch("/get-symbols");
            symbols = await response.json();
            displaySymbols();
        }

        function addSymbol() {
            const symbol = document.getElementById('symbol').value;
            if (symbol && !symbols[symbol]) {
                fetch(`/add-symbol?symbol=${symbol}`, {method: 'POST'})
                    .then(() => {
                        fetch(`/get-symbol-name?symbol=${symbol}`)
                            .then(response => response.text())
                            .then(name => {
                                symbols[symbol] = name;
                                displaySymbols();
                                document.getElementById('symbol').value = '';
                            });
                    });
            }
        }

        function removeSymbol(symbol) {
            // 확인 대화상자를 띄우고, 사용자가 '확인'을 클릭한 경우에만 삭제를 진행합니다.
            if (confirm('本当にリストから削除しますか?')) {
                fetch(`/remove-symbol?symbol=${symbol}`, {method: 'POST'})
                    .then(() => {
                        delete symbols[symbol];
                        displaySymbols();
                    })
                    .catch(error => console.error('Error removing symbol:', error));
            }
        }

        function displaySymbols() {
            const symbolList = document.getElementById('symbolList');
            symbolList.innerHTML = '';
            for (const [symbol, name] of Object.entries(symbols)) {
                symbolList.innerHTML += `<li>${name} (${symbol}) <button class="delete-btn" onclick="removeSymbol('${symbol}')">削除</button></li>`;
            }
        }

        function resetSymbols() {
            if (confirm("本当に初期状態にリセットしますか?")) {  // 확인문구 추가
                fetch("/reset-symbols", {method: 'POST'})
                    .then(() => fetchSavedSymbols())
                    .catch(error => console.error('Error resetting symbols:', error));
            }
        }

        window.onload = function () {
            fetchSavedSymbols();
        };

        async function fetchFinancialData() {
            // 로딩 상태 표시
            document.getElementById('loading-container').style.display = 'flex';

            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            if (!startDate || !endDate || Object.keys(symbols).length === 0) {
                alert('모든 입력값을 채워주세요.');
                document.getElementById('loading-container').style.display = 'none'; // 로딩 상태 숨김
                return;
            }

            const symbolList = Object.keys(symbols).join(',');
            try {
                const response = await fetch(`/financial-data?startDate=${new Date(startDate).getTime() / 1000}&endDate=${new Date(endDate).getTime() / 1000}&symbol=${symbolList}`);
                const data = await response.json();

                if (response.ok) {
                    displayData(data);
                } else {
                    alert('데이터를 가져오는 데 실패했습니다.');
                }
            } catch (error) {
                console.error('Error fetching data:', error);
                alert('데이터를 가져오는 데 실패했습니다.');
            } finally {
                // 데이터 로딩 완료 후 로딩 상태 숨김
                document.getElementById('loading-container').style.display = 'none';
            }
        }

        function displayData(data) {
            const tableBody = document.getElementById('financialData');
            tableBody.innerHTML = '';

            if (!data || data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="9">데이터가 없습니다</td></tr>';
                return;
            }

            data.forEach(entry => {
                const symbol = entry.symbol;
                const secUrl = `https://www.sbisec.co.jp/ETGate/?_ControlID=WPLETsiR001Control&_PageID=WPLETsiR001Idtl30&_DataStoreID=DSWPLETsiR001Control&_ActionID=DefaultAID&s_rkbn=2&s_btype=&i_stock_sec=${symbol}&i_dom_flg=1&i_exchange_code=JPN&i_output_type=2&exchange_code=TKY&stock_sec_code_mul=${symbol}&ref_from=1&ref_to=20&wstm4130_sort_id=&wstm4130_sort_kbn=&qr_keyword=1&qr_suggest=1&qr_sort=1`;

                const row = `
                                <tr>
                                    <td>${entry.date}</td>
                                    <td><a href="${secUrl}" target="_blank">${entry.shortName}</a></td>
                                    <td>${entry.open === 0.0 ? "---------" : entry.open.toFixed(1)}</td>
                                    <td>${entry.price10 === 0.0 ? "---------" : entry.price10.toFixed(1)}</td>
                                    <td>${entry.price11 === 0.0 ? "---------" : entry.price11.toFixed(1)}</td>
                                    <td>${entry.price13 === 0.0 ? "---------" : entry.price13.toFixed(1)}</td>
                                    <td>${entry.price14 === 0.0 ? "---------" : entry.price14.toFixed(1)}</td>
                                    <td>${entry.close === 0.0 ? "---------" : entry.close.toFixed(1)}</td>
                                    <td><input type="text" value=""></td>
                                </tr>
                            `;
                tableBody.innerHTML += row;
            });
        }

        function exportToExcel() {
            const table = document.getElementById('financialData');
            const rows = Array.from(table.querySelectorAll('tr'));

            // 헤더와 데이터를 설정
            const header = ["日付", "銘柄", "始値", "10:00", "11:00", "13:00", "14:00", "終値", "備考"];
            const excelData = rows.map(row => {
                const tdCells = Array.from(row.querySelectorAll('td:not(:last-child)')); // 마지막 td를 제외
                const inputCells = Array.from(row.querySelectorAll('input'));
                const tdValues = tdCells.map(td => td.innerText.trim());
                const inputValues = inputCells.map(input => input.value.trim());
                return [...tdValues, ...inputValues];
            });
            excelData.unshift(header);

            // 워크시트 생성
            const ws = XLSX.utils.aoa_to_sheet(excelData);

            // 스타일 설정
            const headerStyle = {
                fill: {fgColor: {rgb: "FFFFE0"}}, // 연한 노란색
                font: {bold: true, color: {rgb: "000000"}, sz: 14}, // 굵은 글씨, 글씨 크기 16
                alignment: {horizontal: "center", vertical: "center"}, // 가운데 정렬
                border: {
                    top: {style: "thin", color: {rgb: "000000"}},
                    bottom: {style: "thin", color: {rgb: "000000"}}
                }
            };
            const dateStyle = {
                fill: {fgColor: {rgb: "D3D3D3"}}, // 연회색
                font: {bold: true, color: {rgb: "000000"}}, // 굵은 글씨
                alignment: {horizontal: "center", vertical: "center"} // 가운데 정렬
            };
            const nameStyle = {
                fill: {fgColor: {rgb: "ADD8E6"}}, // 연파란색
                font: {bold: true, color: {rgb: "000000"}}, // 굵은 글씨
                alignment: {horizontal: "center", vertical: "center"} // 가운데 정렬
            };
            const generalStyle = {
                alignment: {horizontal: "center", vertical: "center"} // 가운데 정렬
            };

            // 열 너비 조정
            ws['!cols'] = header.map((_, i) => ({wpx: i === 1 ? 220 : 120})); // 2열의 너비를 현재의 1.6배로 설정

            // 스타일 적용: 헤더
            for (let i = 0; i < header.length; i++) {
                const cellAddress = {c: i, r: 0}; // 첫 번째 행, 각 열
                const cellRef = XLSX.utils.encode_cell(cellAddress);
                if (!ws[cellRef]) ws[cellRef] = {};
                ws[cellRef].s = headerStyle; // 헤더 스타일 적용
            }

            // 스타일 적용: 날짜와 기업명 열
            for (let r = 1; r < excelData.length; r++) { // 첫 번째 행(헤더)을 제외
                const dateCellAddress = {c: 0, r: r}; // 첫 번째 열, 각 행
                const nameCellAddress = {c: 1, r: r}; // 두 번째 열, 각 행
                const dateCellRef = XLSX.utils.encode_cell(dateCellAddress);
                const nameCellRef = XLSX.utils.encode_cell(nameCellAddress);
                if (!ws[dateCellRef]) ws[dateCellRef] = {};
                if (!ws[nameCellRef]) ws[nameCellRef] = {};
                ws[dateCellRef].s = dateStyle; // 날짜 열 스타일 적용
                ws[nameCellRef].s = nameStyle; // 기업명 열 스타일 적용
            }

            // 스타일 적용: 나머지 셀
            for (let r = 1; r < excelData.length; r++) { // 첫 번째 행(헤더)을 제외
                for (let c = 2; c < header.length; c++) { // 데이터 열
                    const cellAddress = {c: c, r: r};
                    const cellRef = XLSX.utils.encode_cell(cellAddress);
                    if (!ws[cellRef]) ws[cellRef] = {};
                    ws[cellRef].s = generalStyle; // 나머지 셀 스타일 적용
                }
            }

            // 행 높이 조정: 헤더의 행 높이를 1.5배로 설정
            ws['!rows'] = [{hpx: 30}]; // 헤더의 행 높이를 30px로 설정 (기본값보다 1.5배 높음)

            // 워크북 생성 및 시트 추가
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Financial Data');

            // 엑셀 파일 다운로드
            XLSX.writeFile(wb, 'financial_data.xlsx');
        }
    </script>
</head>
<body>
<div class="container">
    <h1>株価検索データ V1.0</h1>

    <div class="form-container">
        <div class="symbol-section">
            <h2>検索する企業リスト</h2>
            <div class="symbol-input-group">
                <input type="text" id="symbol" placeholder="例） 6701, 6758">
                <button class="add-btn" type="submit" onclick="addSymbol()">追加</button>
            </div>
            <ul id="symbolList"><!DOCTYPE html>
                <html lang="en">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Financial Data</title>
                    <style>
                        body {
                            font-family: 'Arial', sans-serif;
                            background-color: #f4f4f9;
                            color: #333;
                            margin: 0;
                            padding: 0;
                            display: flex;
                            justify-content: center;
                        }

                        .container {
                            max-width: 1200px;
                            width: 100%;
                            padding: 20px;
                            display: flex;
                            flex-direction: column;
                            gap: 20px;
                        }

                        h1 {
                            background-color: #4a90e2;
                            color: #fff;
                            padding: 20px;
                            text-align: center;
                            margin: 0;
                            border-radius: 8px;
                        }

                        h2 {
                            border-bottom: 2px solid #4a90e2;
                            padding-bottom: 10px;
                            margin: 20px 0;
                            font-size: 1.5em;
                        }

                        .form-container {
                            display: flex;
                            flex-wrap: wrap;
                            gap: 20px;
                        }

                        .symbol-section {
                            background-color: #fff;
                            padding: 20px;
                            border-radius: 8px;
                            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
                            flex: 2;
                            min-width: 300px;
                        }

                        .symbol-input-group {
                            display: flex;
                            flex-direction: column;
                            gap: 10px;
                        }

                        .symbol-input-group input {
                            padding: 10px;
                            border-radius: 4px;
                            border: 1px solid #ddd;
                        }

                        /* 공통 버튼 스타일 */
                        .symbol-input-group button {
                            padding: 10px; /* 기본 패딩 */
                            border-radius: 4px; /* 둥근 모서리 */
                            color: white; /* 글씨 색상 */
                            border: none; /* 테두리 제거 */
                            cursor: pointer; /* 마우스 커서를 포인터로 변경 */
                            font-size: 0.9em; /* 버튼 글씨 크기 */
                            transition: background-color 0.3s ease; /* 배경색 변경 애니메이션 */
                        }

                        /* 추가 버튼 스타일 */
                        .symbol-input-group button.add-btn {
                            background-color: #4a90e2; /* 추가 버튼의 원래 색상 */
                        }

                        .symbol-input-group button.add-btn:hover {
                            background-color: #357abd; /* 추가 버튼 hover 시 색상 */
                        }

                        /* 삭제 버튼 스타일 */
                        .symbol-input-group button.delete-btn {
                            padding: 6px 12px; /* 삭제 버튼의 세로 길이를 조금 작게 설정 */
                            background-color: #f44336; /* 삭제 버튼 색상 */
                            color: white; /* 글씨 색상 */
                        }

                        .symbol-input-group button.delete-btn:hover {
                            background-color: #d32f2f; /* 삭제 버튼 hover 시 색상 */
                        }

                        #symbolList {
                            margin-top: 20px;
                            max-height: 200px;
                            overflow-y: auto;
                        }

                        #symbolList li {
                            padding: 10px;
                            border-bottom: 1px solid #ddd;
                            display: flex;
                            justify-content: space-between;
                        }

                        .reset-btn {
                            background-color: #f44336;
                            padding: 10px;
                            border-radius: 4px;
                            color: white;
                            cursor: pointer;
                            margin-top: 10px;
                        }

                        .reset-btn:hover {
                            background-color: #d32f2f;
                        }

                        .date-section {
                            background-color: #fff;
                            padding: 20px;
                            border-radius: 8px;
                            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
                            flex: 1;
                            min-width: 300px;
                        }

                        .date-section input {
                            padding: 10px;
                            border-radius: 4px;
                            border: 1px solid #ddd;
                            width: 94%;
                            margin-bottom: 10px;
                        }

                        .date-section button {
                            padding: 10px;
                            border-radius: 4px;
                            background-color: #4a90e2;
                            color: #fff;
                            cursor: pointer;
                            margin-top: 30px;
                            width: 100%
                        }

                        .date-section button:hover {
                            background-color: #357abd;
                        }

                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin: 20px 0;
                            background-color: #fff;
                            border-radius: 8px;
                            overflow: hidden;
                            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
                        }

                        table, th, td {
                            border: 1px solid #ddd;
                        }

                        th, td {
                            padding: 12px;
                            text-align: left;
                        }

                        th {
                            background-color: #4a90e2;
                            color: #fff;
                        }

                        tr:nth-child(even) {
                            background-color: #f9f9f9;
                        }

                        tr:hover {
                            background-color: #f1f1f1;
                        }

                        .export-btn {
                            padding: 10px;
                            border-radius: 4px;
                            background-color: #4a90e2;
                            color: #fff;
                            cursor: pointer;
                        }

                        .export-btn:hover {
                            background-color: #357abd;
                        }
                    </style>
                    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
                    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.min.js"></script>
                    <script>
                        let symbols = [];

                        async function fetchSavedSymbols() {
                            const response = await fetch("/get-symbols");
                            symbols = await response.json();
                            displaySymbols();
                        }

                        function addSymbol() {
                            const symbol = document.getElementById('symbol').value;
                            if (symbol && !symbols[symbol]) {
                                fetch(`/add-symbol?symbol=${symbol}`, {method: 'POST'})
                                    .then(() => {
                                        fetch(`/get-symbol-name?symbol=${symbol}`)
                                            .then(response => response.text())
                                            .then(name => {
                                                symbols[symbol] = name;
                                                displaySymbols();
                                                document.getElementById('symbol').value = '';
                                            });
                                    });
                            }
                        }

                        function removeSymbol(symbol) {
                            fetch(`/remove-symbol?symbol=${symbol}`, {method: 'POST'})
                                .then(() => {
                                    delete symbols[symbol];
                                    displaySymbols();
                                })
                                .catch(error => console.error('Error removing symbol:', error));
                        }

                        function displaySymbols() {
                            const symbolList = document.getElementById('symbolList');
                            symbolList.innerHTML = '';
                            for (const [symbol, name] of Object.entries(symbols)) {
                                symbolList.innerHTML += `<li>${name} (${symbol}) <button class="delete-btn" onclick="removeSymbol('${symbol}')">削除</button></li>`;
                            }
                        }

                        function resetSymbols() {
                            fetch("/reset-symbols", {method: 'POST'})
                                .then(() => fetchSavedSymbols())
                                .catch(error => console.error('Error resetting symbols:', error));
                        }

                        window.onload = function () {
                            fetchSavedSymbols();
                        };

                        async function fetchFinancialData() {
                            const startDate = document.getElementById('startDate').value;
                            const endDate = document.getElementById('endDate').value;

                            if (!startDate || !endDate || Object.keys(symbols).length === 0) {
                                alert('모든 입력값을 채워주세요.');
                                return;
                            }

                            const symbolList = Object.keys(symbols).join(',');
                            const response = await fetch(`/financial-data?startDate=${new Date(startDate).getTime() / 1000}&endDate=${new Date(endDate).getTime() / 1000}&symbol=${symbolList}`);
                            const data = await response.json();

                            if (response.ok) {
                                displayData(data);
                            } else {
                                alert('데이터를 가져오는 데 실패했습니다.');
                            }
                        }

                        function displayData(data) {
                            const tableBody = document.getElementById('financialData');
                            tableBody.innerHTML = '';

                            if (!data || data.length === 0) {
                                tableBody.innerHTML = '<tr><td colspan="9">데이터가 없습니다</td></tr>';
                                return;
                            }

                            data.forEach(entry => {
                                const symbol = entry.symbol;
                                const secUrl = `https://www.sbisec.co.jp/ETGate/?_ControlID=WPLETsiR001Control&_PageID=WPLETsiR001Idtl30&_DataStoreID=DSWPLETsiR001Control&_ActionID=DefaultAID&s_rkbn=2&s_btype=&i_stock_sec=${symbol}&i_dom_flg=1&i_exchange_code=JPN&i_output_type=2&exchange_code=TKY&stock_sec_code_mul=${symbol}&ref_from=1&ref_to=20&wstm4130_sort_id=&wstm4130_sort_kbn=&qr_keyword=1&qr_suggest=1&qr_sort=1`;

                                const row = `
                    <tr>
                        <td>${entry.date}</td>
                        <td><a href="${secUrl}" target="_blank">${entry.shortName}</a></td>
                        <td>${entry.open.toFixed(1)}</td>
                        <td>${entry.price10.toFixed(1)}</td>
                        <td>${entry.price11.toFixed(1)}</td>
                        <td>${entry.price13.toFixed(1)}</td>
                        <td>${entry.price14.toFixed(1)}</td>
                        <td>${entry.close.toFixed(1)}</td>
                        <td><input type="text" value=""></td>
                    </tr>
                `;
                                tableBody.innerHTML += row;
                            });
                        }

                        function exportToExcel() {
                            const table = document.getElementById('financialData');
                            const rows = Array.from(table.querySelectorAll('tr'));

                            // 헤더와 데이터를 설정
                            const header = ["날짜", "기업명", "시가", "10:00", "11:00", "13:00", "14:00", "종가", "비고"];
                            const excelData = rows.map(row => {
                                const tdCells = Array.from(row.querySelectorAll('td:not(:last-child)')); // 마지막 td를 제외
                                const inputCells = Array.from(row.querySelectorAll('input'));
                                const tdValues = tdCells.map(td => td.innerText.trim());
                                const inputValues = inputCells.map(input => input.value.trim());
                                return [...tdValues, ...inputValues];
                            });
                            excelData.unshift(header);

                            // 워크시트 생성
                            const ws = XLSX.utils.aoa_to_sheet(excelData);

                            // 스타일 설정
                            const headerStyle = {
                                fill: {fgColor: {rgb: "FFFFE0"}}, // 연한 노란색
                                font: {bold: true, color: {rgb: "000000"}, sz: 14}, // 굵은 글씨, 글씨 크기 16
                                alignment: {horizontal: "center", vertical: "center"}, // 가운데 정렬
                                border: {
                                    top: {style: "thin", color: {rgb: "000000"}},
                                    bottom: {style: "thin", color: {rgb: "000000"}}
                                }
                            };
                            const dateStyle = {
                                fill: {fgColor: {rgb: "D3D3D3"}}, // 연회색
                                font: {bold: true, color: {rgb: "000000"}}, // 굵은 글씨
                                alignment: {horizontal: "center", vertical: "center"} // 가운데 정렬
                            };
                            const nameStyle = {
                                fill: {fgColor: {rgb: "ADD8E6"}}, // 연파란색
                                font: {bold: true, color: {rgb: "000000"}}, // 굵은 글씨
                                alignment: {horizontal: "center", vertical: "center"} // 가운데 정렬
                            };
                            const generalStyle = {
                                alignment: {horizontal: "center", vertical: "center"} // 가운데 정렬
                            };

                            // 열 너비 조정
                            ws['!cols'] = header.map((_, i) => ({wpx: i === 1 ? 220 : 120})); // 2열의 너비를 현재의 1.6배로 설정

                            // 스타일 적용: 헤더
                            for (let i = 0; i < header.length; i++) {
                                const cellAddress = {c: i, r: 0}; // 첫 번째 행, 각 열
                                const cellRef = XLSX.utils.encode_cell(cellAddress);
                                if (!ws[cellRef]) ws[cellRef] = {};
                                ws[cellRef].s = headerStyle; // 헤더 스타일 적용
                            }

                            // 스타일 적용: 날짜와 기업명 열
                            for (let r = 1; r < excelData.length; r++) { // 첫 번째 행(헤더)을 제외
                                const dateCellAddress = {c: 0, r: r}; // 첫 번째 열, 각 행
                                const nameCellAddress = {c: 1, r: r}; // 두 번째 열, 각 행
                                const dateCellRef = XLSX.utils.encode_cell(dateCellAddress);
                                const nameCellRef = XLSX.utils.encode_cell(nameCellAddress);
                                if (!ws[dateCellRef]) ws[dateCellRef] = {};
                                if (!ws[nameCellRef]) ws[nameCellRef] = {};
                                ws[dateCellRef].s = dateStyle; // 날짜 열 스타일 적용
                                ws[nameCellRef].s = nameStyle; // 기업명 열 스타일 적용
                            }

                            // 스타일 적용: 나머지 셀
                            for (let r = 1; r < excelData.length; r++) { // 첫 번째 행(헤더)을 제외
                                for (let c = 2; c < header.length; c++) { // 데이터 열
                                    const cellAddress = {c: c, r: r};
                                    const cellRef = XLSX.utils.encode_cell(cellAddress);
                                    if (!ws[cellRef]) ws[cellRef] = {};
                                    ws[cellRef].s = generalStyle; // 나머지 셀 스타일 적용
                                }
                            }

                            // 행 높이 조정: 헤더의 행 높이를 1.5배로 설정
                            ws['!rows'] = [{hpx: 30}]; // 헤더의 행 높이를 30px로 설정 (기본값보다 1.5배 높음)

                            // 워크북 생성 및 시트 추가
                            const wb = XLSX.utils.book_new();
                            XLSX.utils.book_append_sheet(wb, ws, 'Financial Data');

                            // 엑셀 파일 다운로드
                            XLSX.writeFile(wb, 'financial_data.xlsx');
                        }
                    </script>
                </head>
                <body>
                <div class="container">
                    <h1>株価検索データ V1.0</h1>

                    <div class="form-container">
                        <div class="symbol-section">
                            <h2>検索する企業リスト</h2>
                            <div class="symbol-input-group">
                                <input type="text" id="symbol" placeholder="例） 6701, 6758">
                                <button type="submit" onclick="addSymbol()">追加</button>
                            </div>
                            <ul id="symbolList">
                                <!-- 추가된 기업 코드 목록 -->
                            </ul>
                            <button class="reset-btn" onclick="resetSymbols()">企業リストをリセットする</button>
                        </div>

                        <div class="date-section">
                            <div>
                                <label for="startDate">検索開始日　:</label>
                                <input type="date" id="startDate">
                            </div>
                            <div>
                                <label for="endDate">検索終了日 :</label>
                                <input type="date" id="endDate">
                            </div>
                            <button type="submit" onclick="fetchFinancialData()">検索</button>
                        </div>
                    </div>

                    <h2>検索結果
                        <button class="export-btn" onclick="exportToExcel()">Excelに変換</button>
                    </h2>
                    <h4>
                        まだ株式市場が終了していない時間の場合、表記された時間までデータが出力され、当日の終値が異常なデータが出力されることがあります。</h4>
                    <table>
                        <thead>
                        <tr>
                            <th>日付</th>
                            <th>銘柄</th>
                            <th>始値</th>
                            <th>10:00</th>
                            <th>11:00</th>
                            <th>13:00</th>
                            <th>14:00</th>
                            <th>終値</th>
                            <th>備考</th>
                        </tr>
                        </thead>
                        <tbody id="financialData">
                        <!-- 데이터가 여기 채워집니다 -->
                        </tbody>
                    </table>
                </div>
                </body>
                </html>

                <!-- 추가된 기업 코드 목록 -->
            </ul>
            <button class="reset-btn" onclick="resetSymbols()">企業リストをリセットする</button>
        </div>

        <div class="date-section">
            <div>
                <label for="startDate">検索開始日　:</label>
                <input type="date" id="startDate">
            </div>
            <div>
                <label for="endDate">検索終了日 :</label>
                <input type="date" id="endDate">
            </div>
            <button type="submit" onclick="fetchFinancialData()">検索</button>
        </div>
    </div>

    <h2>検索結果
        <button class="export-btn" onclick="exportToExcel()">Excelに変換</button>
    </h2>
    <h4>
        まだ株式市場が終了していない時間の場合、表記された時間までデータが出力され、当日の終値が異常なデータが出力されることがあります。</h4>
    <table>
        <thead>
        <tr>
            <th>日付</th>
            <th>銘柄</th>
            <th>始値</th>
            <th>10:00</th>
            <th>11:00</th>
            <th>13:00</th>
            <th>14:00</th>
            <th>終値</th>
            <th>備考</th>
        </tr>
        </thead>
        <tbody id="financialData">
        <!-- 데이터가 여기 채워집니다 -->
        </tbody>
    </table>
</div>
<!-- 로딩 상태 컨테이너 -->
<div id="loading-container" style="display: none;">
    <div id="loading">
        検索中です。。。
    </div>
</div>
</body>
</html>
