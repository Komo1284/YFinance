<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Data</title>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
        }
        table, th, td {
            border: 1px solid black;
        }
        th, td {
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
    </style>
    <script>
        let symbols = [];

        async function fetchSavedSymbols() {
            const response = await fetch("/get-symbols");
            symbols = await response.json();
            displaySymbols();
        }

        function addSymbol() {
            const symbol = document.getElementById('symbol').value;
            if (symbol && !symbols[symbol]) {
                fetch(`/add-symbol?symbol=${symbol}`, { method: 'POST' })
                    .then(() => {
                        // 기업명 가져오기
                        fetch(`/get-symbol-name?symbol=${symbol}`)
                            .then(response => response.text())
                            .then(name => {
                                symbols[symbol] = name; // 기업명과 함께 업데이트
                                displaySymbols();
                                document.getElementById('symbol').value = '';
                            });
                    });
            }
        }

        function removeSymbol(symbol) {
            fetch(`/remove-symbol?symbol=${symbol}`, { method: 'POST' })
                .then(() => {
                    // 기업 목록 업데이트
                    delete symbols[symbol];
                    displaySymbols();
                })
                .catch(error => console.error('Error removing symbol:', error));
        }

        function displaySymbols() {
            const symbolList = document.getElementById('symbolList');
            symbolList.innerHTML = '';
            for (const [symbol, name] of Object.entries(symbols)) {
                symbolList.innerHTML += `<li>${name} (${symbol}) <button onclick="removeSymbol('${symbol}')">Remove</button></li>`;
            }
        }

        function resetSymbols() {
            fetch("/reset-symbols", { method: 'POST' })
                .then(() => fetchSavedSymbols())
                .catch(error => console.error('Error resetting symbols:', error));
        }

        window.onload = function () {
            fetchSavedSymbols();
        };

        async function fetchFinancialData() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            if (!startDate || !endDate || Object.keys(symbols).length === 0) {
                alert('모든 입력값을 채워주세요.');
                return;
            }

            const symbolList = Object.keys(symbols).join(',');
            const response = await fetch(`/financial-data?startDate=${new Date(startDate).getTime() / 1000}&endDate=${new Date(endDate).getTime() / 1000}&symbol=${symbolList}`);
            const data = await response.json();

            if (response.ok) {
                displayData(data);
            } else {
                alert('데이터를 가져오는 데 실패했습니다.');
            }
        }

        function displayData(data) {
            const tableBody = document.getElementById('financialData');
            tableBody.innerHTML = '';

            if (!data || data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="9">데이터가 없습니다</td></tr>';
                return;
            }

            data.forEach(entry => {
                // 기업 코드를 추출하여 링크 생성
                const symbol = entry.symbol;  // 이 부분은 데이터에 symbol이 포함되어 있다고 가정
                const secUrl = `https://www.sbisec.co.jp/ETGate/?_ControlID=WPLETsiR001Control&_PageID=WPLETsiR001Idtl30&_DataStoreID=DSWPLETsiR001Control&_ActionID=DefaultAID&s_rkbn=2&s_btype=&i_stock_sec=${symbol}&i_dom_flg=1&i_exchange_code=JPN&i_output_type=2&exchange_code=TKY&stock_sec_code_mul=${symbol}&ref_from=1&ref_to=20&wstm4130_sort_id=&wstm4130_sort_kbn=&qr_keyword=1&qr_suggest=1&qr_sort=1`;

                const row = `
            <tr>
                <td>${entry.date}</td>
                <td><a href="${secUrl}" target="_blank">${entry.shortName}</a></td>
                <td>${entry.open}</td>
                <td>${entry.price10}</td>
                <td>${entry.price11}</td>
                <td>${entry.price13}</td>
                <td>${entry.price14}</td>
                <td>${entry.close}</td>
                <td><textarea>메모</textarea></td>
            </tr>
        `;
                tableBody.innerHTML += row;
            });
        }
    </script>
</head>
<body>
<h1>Financial Data</h1>

<form onsubmit="event.preventDefault(); addSymbol();">
    <label for="symbol">기업 코드 추가:</label>
    <input type="text" id="symbol" placeholder="예: 6701, 6758">
    <button type="submit">추가</button>
</form>

<ul id="symbolList">
    <!-- 추가된 기업 코드 목록 -->
</ul>

<!-- 리셋 버튼 추가 -->
<button onclick="resetSymbols()">기업 목록 리셋</button>

<form onsubmit="event.preventDefault(); fetchFinancialData();">
    <label for="startDate">시작 날짜:</label>
    <input type="date" id="startDate"><br><br>

    <label for="endDate">종료 날짜:</label>
    <input type="date" id="endDate"><br><br>

    <button type="submit">데이터 조회</button>
</form>

<h2>조회 결과</h2>
<table>
    <thead>
    <tr>
        <th>날짜</th>
        <th>기업명</th>
        <th>시가</th>
        <th>10:00</th>
        <th>11:00</th>
        <th>13:00</th>
        <th>14:00</th>
        <th>종가</th>
        <th>비고</th>
    </tr>
    </thead>
    <tbody id="financialData">
    <!-- 데이터가 여기 채워집니다 -->
    </tbody>
</table>
</body>
</html>
